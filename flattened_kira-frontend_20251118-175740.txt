==================================
FLATTENED: kira-frontend
Type: Submodule
Generated at: Tue Nov 18 17:57:40 UTC 2025
Branch: main
Commit: bfd10fb20600ff2b036380e0486e740d22c3473c
Repository: judasane/kira-frontend
==================================

--- START OF FILE: .github/workflows/ci.yml ---
name: Run lint, build and tests
on:
  push:

jobs:
  lint-build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Test
        run: npm run test:coverage

--- END OF FILE: .github/workflows/ci.yml ---

--- START OF FILE: .github/workflows/deploy.yml ---
name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build application
        run: npm run build -- --configuration production --base-href /kira-frontend/

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist/browser'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

--- END OF FILE: .github/workflows/deploy.yml ---

--- START OF FILE: .github/workflows/flat.yml ---
name: ğŸ¦‰ Flatten Repository

on:
  push:
    branches:
      - main
      - development
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  flatten-and-commit:
    name: Generate Flattened Repository File
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.PAT_FLATTEN || github.token }}
          # Use PAT_FLATTEN if available for protected branches, otherwise use default GITHUB_TOKEN

      - name: Generate flattened file
        run: |
          echo "ğŸ” Starting flatten process..."
          
          echo "ğŸ“‹ Files currently tracked by git:"
          git ls-files 'flattened*.txt' 'repository_flattened.txt' 'flattened_output.txt' 2>/dev/null || echo "No flattened files in git"
          
          # Generate filename with repo name and timestamp
          REPO_NAME=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f2)
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          OUTPUT_FILE="flattened_${REPO_NAME}_${TIMESTAMP}.txt"
          
          echo "ğŸ“ Output file will be: $OUTPUT_FILE"
          
          # Detect if this is a submodule or main project
          IS_SUBMODULE="false"
          if [ ! -f .gitmodules ]; then
            IS_SUBMODULE="true"
          fi
          
          EXCLUDE_EXTENSIONS="map,tsbuildinfo,log,lock,db,sqlite,sqlite3,dump,lcov,png,jpg,jpeg,gif,ico,zip,gz,pdf,mp4,svg"
          EXCLUDE_FILES="package-lock.json,yarn.lock,pnpm-lock.yaml"
          EXCLUDE_DIRS="node_modules,bower_components,dist,build,out,.next,.nuxt,.svelte-kit,coverage,.idea,.vscode,.fleet,.venv,venv"
          
          echo "==================================" > "$OUTPUT_FILE"
          echo "FLATTENED: $REPO_NAME" >> "$OUTPUT_FILE"
          echo "Type: $([ "$IS_SUBMODULE" = "true" ] && echo "Submodule" || echo "Main Project")" >> "$OUTPUT_FILE"
          echo "Generated at: $(date)" >> "$OUTPUT_FILE"
          echo "Branch: ${GITHUB_REF##*/}" >> "$OUTPUT_FILE"
          echo "Commit: ${GITHUB_SHA}" >> "$OUTPUT_FILE"
          echo "Repository: $GITHUB_REPOSITORY" >> "$OUTPUT_FILE"
          echo "==================================" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          
          # List submodules if they exist (main project only)
          if [ -f .gitmodules ]; then
            echo "--- GIT SUBMODULES ---" >> "$OUTPUT_FILE"
            echo "Submodules are managed independently." >> "$OUTPUT_FILE"
            echo "To see their flattened code, check their respective repositories." >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            git config --file .gitmodules --get-regexp path | awk '{ print $2 }' | while read -r submodule; do
              if ls "$submodule"/flattened_*.txt 1> /dev/null 2>&1; then
                echo "  - $submodule (has flattened files)" >> "$OUTPUT_FILE"
              else
                echo "  - $submodule" >> "$OUTPUT_FILE"
              fi
            done
            echo "------------------------------------" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
          fi
          
          exclude_ext_pattern=$(echo "$EXCLUDE_EXTENSIONS" | sed 's/,/|/g')
          exclude_files_pattern="$(echo "$EXCLUDE_FILES" | sed 's/,/|/g')"
          exclude_dirs_pattern=$(echo "$EXCLUDE_DIRS" | sed 's/,/|/g')
          
          echo "ğŸ” Scanning repository files..."
          FILE_COUNT=0
          
          git ls-files | \
          grep -vE "^($exclude_dirs_pattern)/" | \
          grep -vE "\.($exclude_ext_pattern)$" | \
          grep -vE "^($exclude_files_pattern)$" | \
          grep -vE "^flattened.*\.txt$" | \
          grep -vE "^repository_flattened\.txt$" | \
          while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "--- START OF FILE: $file ---" >> "$OUTPUT_FILE"
                cat "$file" >> "$OUTPUT_FILE"
                echo -e "\n--- END OF FILE: $file ---\n" >> "$OUTPUT_FILE"
                FILE_COUNT=$((FILE_COUNT + 1))
              fi
          done
          
          echo "âœ… Repository flattened into $OUTPUT_FILE"
          
          # Verify file was created
          if [ -f "$OUTPUT_FILE" ]; then
            FILE_SIZE=$(wc -c < "$OUTPUT_FILE")
            echo "ğŸ“Š File created successfully: $FILE_SIZE bytes"
            echo "ğŸ“„ First few lines:"
            head -n 10 "$OUTPUT_FILE"
          else
            echo "âŒ ERROR: Output file was not created!"
            exit 1
          fi
          
          # Save variables for later steps
          echo "OUTPUT_FILE=$OUTPUT_FILE" >> $GITHUB_ENV
          echo "IS_SUBMODULE=$IS_SUBMODULE" >> $GITHUB_ENV

      - name: Commit and push flattened file
        run: |
          echo "ğŸ”§ Configuring git..."
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          echo "ğŸ“‹ Files in working directory BEFORE cleanup:"
          ls -lh flattened*.txt repository_flattened.txt flattened_output.txt 2>/dev/null || echo "No flattened files found"
          
          echo "ğŸ—‘ï¸ Removing ALL old flattened files except the new one..."
          # Use git ls-files to find all tracked flattened files
          git ls-files 'flattened*.txt' 'repository_flattened.txt' 'flattened_output.txt' 2>/dev/null | while read -r old_file; do
            if [ "$old_file" != "$OUTPUT_FILE" ]; then
              echo "  Removing from git: $old_file"
              git rm -f "$old_file"
            fi
          done
          
          echo "ğŸ“‹ Files in working directory AFTER cleanup:"
          ls -lh flattened*.txt 2>/dev/null || echo "Only new file should remain"
          
          echo "â• Adding new flattened file: $OUTPUT_FILE"
          git add -f "$OUTPUT_FILE"
          
          echo "ğŸ“Š Git diff summary:"
          git diff --staged --stat
          
          echo "ğŸ“Š Detailed changes:"
          git status --short
          
          if git diff --staged --quiet; then
            echo "âš ï¸  No changes to commit."
          else
            echo "ğŸ’¾ Committing changes..."
            if [ "$IS_SUBMODULE" = "true" ]; then
              git commit -m "docs: Update flattened repository file [skip ci]" -m "Generated at: $(date)" -m "Auto-generated by GitHub Actions."
            else
              git commit -m "docs: Update flattened repository file" -m "Generated at: $(date)" -m "This commit was generated by a GitHub Action."
            fi
            
            echo "ğŸš€ Pushing to remote..."
            git push
            echo "âœ… Changes pushed successfully!"
          fi

--- END OF FILE: .github/workflows/flat.yml ---

--- START OF FILE: .gitignore ---
# Created by Gemini

# Angular
/dist
/coverage
/.angular/cache

# Dependencies
/node_modules

# IDEs and editors
.idea/
.vscode/

#-*-*-*-

# End of section

--- END OF FILE: .gitignore ---

--- START OF FILE: .idx/dev.nix ---
{pkgs}: {
  channel = "stable-24.11";
  packages = [
    pkgs.nodejs_22
    pkgs.nodePackages."@angular/cli"
    pkgs.github-cli
  ];
  idx.extensions = [];
  idx.previews = {
    previews = {
      web = {
        command = [
          "npm"
          "run"
          "dev"
        ];
        manager = "web";
      };
    };
  };
}
--- END OF FILE: .idx/dev.nix ---

--- START OF FILE: README.md ---

# ğŸ’³ Kira Payment Links - Frontend

<div align="center">

![Angular](https://img.shields.io/badge/Angular-DD0031?style=for-the-badge&logo=angular&logoColor=white)
![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white)

**Secure, PCI-compliant payment checkout interface for Kira's cross-border payment links**

[Live Demo](https://judasane.github.io/kira-frontend/) Â· [Backend Repo](https://github.com/judasane/kira)

</div>

---

## ğŸ“‹ Table of Contents

- [Overview](#-overview)
- [Key Features](#-key-features)
- [Tech Stack](#-tech-stack)
- [Prerequisites](#-prerequisites)
- [Getting Started](#-getting-started)
- [Project Structure](#-project-structure)
- [Development](#-development)
- [Configuration](#-configuration)
- [Deployment](#-deployment)
- [Architecture](#-architecture)
- [Related Documentation](#-related-documentation)

---

## ğŸ¯ Overview

Kira Payment Links Frontend is a **Single Page Application (SPA)** built with Angular that serves as the checkout interface for Kira's payment link system. This application handles the complete payment flow while maintaining **PCI DSS compliance** by tokenizing sensitive card data on the client-side, ensuring that no sensitive payment information ever reaches the backend.

### What Makes This Special?

- ğŸ”’ **PCI-Compliant**: Card data never touches our servers
- ğŸŒ **Cross-Border Ready**: Designed for USD â†’ MXN transactions
- âš¡ **State Management**: Robust UI state machine for all payment scenarios
- ğŸ¨ **Component-Driven**: Clean, maintainable architecture with Smart/Dumb components
- âœ… **Advanced Validation**: Client-side Luhn algorithm and custom validators

---

## âœ¨ Key Features

### Core Functionality

- **Dynamic Payment Rendering**: Fetches and displays payment link information via `GET /payment-links/{id}`
- **Client-Side Tokenization**: Simulates PSP SDK integration for secure card tokenization
- **Multi-State Management**: Handles all payment states:
  - `INITIALIZING` - Application startup
  - `AWAITING_INPUT` - Waiting for payment link ID
  - `LOADING_LINK` - Fetching payment details
  - `LINK_NOT_FOUND` - Invalid or expired link
  - `READY_TO_PAY` - Form ready for user input
  - `PROCESSING_PAYMENT` - Payment being processed
  - `COMPLETED` - Successful payment
  - `FAILED` - Payment failed (with retry option)
  - `ERROR_RETRYABLE` - Recoverable errors

### Security & Validation

- âœ… **Luhn Algorithm**: Built-in credit card number validation
- âœ… **Reactive Forms**: Real-time validation with TypeScript type safety
- âœ… **Mock Token Generation**: Format: `tok_mock_{psp}_{uuid}`
- âœ… **No Sensitive Data Transmission**: PAN and CVC never sent to backend

### User Experience

- ğŸ“Š **Fee Breakdown Component**: Transparent cost display
- ğŸ”„ **Payment Status Feedback**: Clear success/failure messages
- â™»ï¸ **Retry Logic**: Graceful error handling with retry capability
- ğŸ“± **Responsive Design**: Works across devices

---

## ğŸ›  Tech Stack

| Category | Technology |
|----------|-----------|
| **Framework** | Angular 20.x |
| **Language** | TypeScript |
| **Forms** | ReactiveFormsModule |
| **HTTP Client** | HttpClientModule |
| **Routing** | Angular Router |
| **Styling** | TailwindCSS (CDN) |
| **Change Detection** | Zoneless (Signals) |
| **Component Style** | Standalone Components |

---

## ğŸ“¦ Prerequisites

Before you begin, ensure you have the following installed:

- **Node.js**: v20.19.0 or higher
- **npm**: v9.x or higher (comes with Node.js)
- **Angular CLI**: v20.x or higher (optional, project uses custom setup)

```bash
# Verify installations
node --version
npm --version
```

---

## ğŸš€ Getting Started

### 1. Clone the Repository
```bash
git clone https://github.com/judasane/kira-frontend.git
cd kira-frontend
```

### 2. Install Dependencies
```bash
npm install
```

### 3. Configure API Endpoint

The API URL is configured in `src/services/api.service.ts`:

```typescript
// Current configuration
private baseUrl = 'https://kira-payment-api.onrender.com';

// For local development, change to:
// private baseUrl = 'http://localhost:3000';
```

**Note**: This project doesn't use traditional Angular environment files. The API endpoint is directly configured in the service.

### 4. Start Development Server
```bash
npm run dev
```

Navigate to `http://localhost:9002/` in your browser. The app will automatically reload when you make changes.

### 5. Access a Payment Link

Visit: `http://localhost:9002/#/links/{payment-link-id}`

Or use the search interface at: `http://localhost:9002/`

---

## ğŸ“ Project Structure
```
kira-frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.component.ts           # Root component
â”‚   â”œâ”€â”€ app.component.html         # Root template
â”‚   â”œâ”€â”€ app.routes.ts              # Route configuration
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ checkout/              # Main checkout orchestrator (Smart)
â”‚   â”‚   â”‚   â”œâ”€â”€ checkout.component.ts
â”‚   â”‚   â”‚   â””â”€â”€ checkout.component.html
â”‚   â”‚   â”œâ”€â”€ fee-breakdown/         # Fee display (Dumb)
â”‚   â”‚   â”‚   â”œâ”€â”€ fee-breakdown.component.ts
â”‚   â”‚   â”‚   â””â”€â”€ fee-breakdown.component.html
â”‚   â”‚   â””â”€â”€ payment-status/        # Success/failure messages (Dumb)
â”‚   â”‚       â”œâ”€â”€ payment-status.component.ts
â”‚   â”‚       â””â”€â”€ payment-status.component.html
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ api.service.ts         # HTTP client wrapper
â”‚   â”‚   â”œâ”€â”€ mock-psp-sdk.service.ts # PSP simulation
â”‚   â”‚   â””â”€â”€ validation.service.ts  # Custom validators (Luhn, etc.)
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ payment.model.ts       # All TypeScript interfaces
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ deploy.yml             # GitHub Pages deployment
â”‚       â””â”€â”€ flat.yml               # Repository flattening
â”œâ”€â”€ index.html                     # Main HTML file
â”œâ”€â”€ index.tsx                      # Application bootstrap
â”œâ”€â”€ package.json                   # Dependencies and scripts
â”œâ”€â”€ tsconfig.json                  # TypeScript configuration
â”œâ”€â”€ angular.json                   # Angular CLI configuration
â”œâ”€â”€ README.md                      # This file
â””â”€â”€ agents.md                      # AI agent guidelines
```

### Key Components

#### ğŸ§  Smart Components

- **`CheckoutComponent`**
  - Orchestrates the entire payment flow
  - Manages UI state machine
  - Fetches payment link data
  - Handles form submission and API calls

#### ğŸ¨ Dumb Components

- **`FeeBreakdownComponent`**
  - Receives `FeePreview` via `@Input()`
  - Pure presentation of cost breakdown
  
- **`PaymentStatusComponent`**
  - Displays final payment result
  - Shows success/failure messages

### Core Services

| Service | Responsibility |
|---------|---------------|
| **`ApiService`** | Wraps `HttpClient` with typed methods: `getPaymentLink()`, `processPayment()` |
| **`MockPspSdkService`** | Simulates PSP tokenization: `createToken()` returns `Promise<string>` |
| **`ValidationService`** | Provides custom validators: `luhnValidator()` |

---

## ğŸ’» Development

### Available Scripts
```bash
# Start development server (port 9002)
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview
```

### Development Workflow

1. **Create Feature Branch**
```bash
   git checkout -b feature/payment-retry-logic
```

2. **Make Changes** following the component architecture
   - Smart components in `components/`
   - Services in `services/`
   - Models in `models/`

3. **Commit Changes**
```bash
   git commit -m "feat: add payment retry logic"
```

4. **Push and Create PR**

---

## âš™ï¸ Configuration

### API Service Configuration

The API endpoint is configured directly in the service:

**File**: `src/services/api.service.ts`

```typescript
@Injectable({
  providedIn: 'root'
})
export class ApiService {
  private http = inject(HttpClient);
  private baseUrl = 'https://kira-payment-api.onrender.com'; 

  getPaymentLink(id: string): Observable<PaymentLinkWithPreviewResponse> {
    return this.http.get<PaymentLinkWithPreviewResponse>(`${this.baseUrl}/payment-links/${id}`);
  }

  processPayment(id: string, request: ProcessPaymentRequest): Observable<ProcessPaymentResponse> {
    return this.http.post<ProcessPaymentResponse>(`${this.baseUrl}/payment-links/${id}/payments`, request);
  }
}
```

**To change the API URL:**

1. Open `src/services/api.service.ts`
2. Modify the `baseUrl` property:
   - **Production**: `'https://kira-payment-api.onrender.com'`
   - **Local Development**: `'http://localhost:3000'`
   - **Staging**: `'https://staging-api.kira.com'`

### Mock PSP Configuration

The mock PSP service simulates tokenization latency:

**File**: `src/services/mock-psp-sdk.service.ts`

```typescript
createToken(psp: 'STRIPE' | 'ADYEN'): Promise<string> {
  return new Promise(resolve => {
    // Simulate network latency for the tokenization request
    const latency = 500 + Math.random() * 500; // 500ms to 1000ms
    
    setTimeout(() => {
      const token = `tok_mock_${psp.toLowerCase()}_${crypto.randomUUID()}`;
      resolve(token);
    }, latency);
  });
}
```

**To adjust tokenization delay:**
- Modify the `latency` calculation for faster/slower simulations
- For production, replace with actual PSP SDK integration

---

## ğŸš¢ Deployment

### GitHub Pages (Current Setup)

This project is configured to deploy to GitHub Pages automatically.

**Deployment Workflow**: `.github/workflows/deploy.yml`

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build application
        run: npm run build -- --configuration production

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
```

**Live URL**: https://judasane.github.io/kira-frontend/

### Manual Deployment

#### Build for Production
```bash
npm run build
```

Output will be in `dist/` directory.

#### Deploy to Other Platforms

**Option 1: Vercel**
```bash
npm install -g vercel
vercel deploy --prod
```

**Option 2: Netlify**
```bash
npm install -g netlify-cli
netlify deploy --prod --dir=dist
```

**Option 3: AWS S3 + CloudFront**
```bash
aws s3 sync dist/ s3://your-bucket-name
aws cloudfront create-invalidation --distribution-id YOUR_DIST_ID --paths "/*"
```

**Option 4: Firebase Hosting**
```bash
firebase deploy
```

---

## ğŸ— Architecture

### State Machine Flow
```
INITIALIZING â†’ AWAITING_INPUT â†’ LOADING_LINK â†’ READY_TO_PAY â†’ PROCESSING_PAYMENT â†’ COMPLETED
                      â†“              â†“                                                    â†“
                LINK_NOT_FOUND  LINK_NOT_FOUND                                        FAILED
                                                                                         â†“
                                                                                   ERROR_RETRYABLE
```

### Payment Flow Sequence

1. **User** navigates to `/links/{id}` or enters ID manually
2. **App** calls `GET /payment-links/{id}` â†’ `LOADING_LINK`
3. **Backend** returns payment details â†’ `READY_TO_PAY`
4. **User** enters card details + submits form
5. **MockPspSdkService** tokenizes card â†’ `tok_mock_stripe_{uuid}`
6. **App** calls `POST /payment-links/{id}/payments` â†’ `PROCESSING_PAYMENT`
7. **Backend** processes payment:
   - Success â†’ `COMPLETED`
   - Failure â†’ `FAILED` (with retry option)
   - Network error â†’ `ERROR_RETRYABLE`

### Component Communication
```
CheckoutComponent (Smart)
â”œâ”€â”€ Inputs: paymentLinkId (from route params)
â”œâ”€â”€ State Management: status signal, paymentLink signal, paymentResult signal
â””â”€â”€ Children:
    â”œâ”€â”€ FeeBreakdownComponent (@Input: feePreview, @Input: baseAmount)
    â””â”€â”€ PaymentStatusComponent (@Input: status, @Input: result)
```

### Data Models

**File**: `src/models/payment.model.ts`

```typescript
// Fee breakdown structure
interface FeePreview {
  fxRate: number;
  totalFeesUsd: number;
  recipientAmountMxn: number;
  breakdown: {
    fixedFeeUsd: number;
    variableFeeUsd: number;
    fxMarkupUsd: number;
    firstTxDiscountUsd: number;
  };
}

// Payment link response
interface PaymentLinkWithPreviewResponse {
  id: string;
  merchantId: string;
  status: 'DRAFT' | 'ACTIVE' | 'EXPIRED' | 'COMPLETED' | 'CANCELLED';
  amountUsd: number;
  description: string;
  expiresAt: string | null;
  feePreview: FeePreview;
  // ... other fields
}

// Payment processing request
interface ProcessPaymentRequest {
  cardToken: string;
  pspProvider: 'STRIPE' | 'ADYEN';
  idempotencyKey: string;
  metadata?: { [key: string]: any };
}

// Payment result
interface ProcessPaymentResponse {
  transactionId: string;
  status: 'COMPLETED' | 'FAILED';
  paymentLinkId: string;
  pspProvider: 'STRIPE' | 'ADYEN';
  amountUsd: number;
  recipientAmountMxn: number;
  fxRateApplied: number;
  totalFeesUsd: number;
}
```

---

## ğŸ“š Related Documentation

- **Backend API**: See backend repository for API documentation
- **Frontend Planning**: [`frontend_angular_plan.md`](frontend_angular_plan.md) *(if available)*
- **AI Agent Guidelines**: [`agents.md`](agents.md)
- **Pending Tasks**: [`TASKS.md`](TASKS.md) - See development roadmap

---

## ğŸ¯ Current Status

### âœ… Implemented Features

- âœ… Payment link fetching and rendering
- âœ… Client-side card validation (Luhn algorithm)
- âœ… Mock PSP tokenization
- âœ… Payment processing integration
- âœ… Fee breakdown display
- âœ… Success/failure states
- âœ… Error handling with retry
- âœ… Responsive design
- âœ… GitHub Pages deployment

### ğŸš§ Pending Improvements

See [`TASKS.md`](TASKS.md) for:
- Testing framework setup
- Linting and code quality tools
- Additional documentation
- Performance optimizations

---

## ğŸ¤ Contributing

This project was built as part of the **Kira Product Engineer Assessment**.

For development:

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'feat: add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

---

## ğŸ“„ License

This project is part of the Kira technical assessment.

---

## ğŸ™ Acknowledgments

- Built with Angular 20 and TypeScript
- Designed for PCI DSS compliance
- Part of Kira's cross-border payment solution (USD â†’ MXN)

---

<div align="center">

**Made with â¤ï¸ for Kira**

[â¬† Back to Top](#-kira-payment-links---frontend)

</div>

--- END OF FILE: README.md ---

--- START OF FILE: agents.md ---
# ğŸ§­ AGENTS.md â€” Kira Payment Links Frontend

> **For project overview and backend architecture, see [README.md](./README.md)**  
> This document contains **operational guidelines for AI agents** working on the Kira Payment Links Frontend codebase.

## ğŸ“˜ Table of Contents

1. [Security Requirements](#1-security-requirements) ğŸ”’
2. [Agent Permissions](#2-agent-permissions) âš–ï¸
3. [Development Commands](#3-development-commands) âš¡
4. [Code Standards](#4-code-standards) ğŸ“‹
5. [TSDoc Documentation Standards](#5-tsdoc-documentation-standards) ğŸ“
6. [Quality Assurance Pipeline](#6-quality-assurance-pipeline) ğŸ›¡ï¸
7. [Style & Reactivity](#7-style--reactivity) ğŸ¨
8. [Testing Overview](#8-testing-overview) ğŸ§ª
9. [Payment Flow Patterns](#9-payment-flow-patterns) ğŸ’³
10. [Operational Checklist](#10-operational-checklist) âœ…
11. [When Stuck](#11-when-stuck) ğŸ¤”
12. [Output Format](#12-output-format) ğŸª„

**Note:** Git Workflow & Branch Strategy covered in section 4 (Code Standards)

---

## 1. Security Requirements

**ğŸš¨ NON-NEGOTIABLE: These security rules must ALWAYS be followed.**

### ğŸ” Critical Rules for Payment Systems

```bash
# âŒ NEVER commit these files
.env
.env.*
*.key
*.pem
config/secrets.json

# âŒ NEVER store real card data (even in mock mode)
const cardNumber = "4242424242424242"  # BAD
const cvv = "123"                       # BAD

# âŒ NEVER send real card data to backend
// This is WRONG - even in development
fetch('/api/payments', {
  body: JSON.stringify({ cardNumber, cvv, expiry })
})

# âœ… ALWAYS use tokenization pattern
// Frontend generates mock token
const cardToken = generateMockToken()
fetch('/api/payments', {
  body: JSON.stringify({ cardToken })  // Only send token
})
```

### Payment Security Checklist

- [ ] `.env*` ignored by git
- [ ] No card data stored in localStorage/sessionStorage
- [ ] Card validation happens client-side only
- [ ] Only mock tokens sent to API
- [ ] CSP headers configured for production
- [ ] HTTPS enforced in production

| Data Type       | Storage Location | Transmission       |
| --------------- | ---------------- | ------------------ |
| **Card Number** | Memory only      | Never sent         |
| **CVV**         | Memory only      | Never sent         |
| **Expiry**      | Memory only      | Never sent         |
| **Card Token**  | Memory only      | Sent to API        |
| **API Keys**    | Environment vars | HTTPS only         |

---

## 2. Agent Permissions

**âš–ï¸ Operational boundaries for AI automation.**

### âœ… Allowed (Level 2 â€” Sandbox)

| Action                 | Example Commands                   | Notes           |
| ---------------------- | ---------------------------------- | --------------- |
| **Read/analyze files** | `cat`, `ls`, `grep`                | Full access     |
| **Lint & format**      | `npm run lint`, `prettier --write` | Reversible      |
| **Type check**         | `tsc --noEmit`                     | Safe            |
| **Run tests**          | `npm test`, `vitest run`           | Non-destructive |
| **Build preview**      | `npm run build`                    | Validation only |
| **Dev server**         | `npm run dev`                      | Local only      |

### ğŸŸ¡ Requires User Approval (Level 3 â€” Privileged)

| Action                      | Command                       | Reason                   |
| --------------------------- | ----------------------------- | ------------------------ |
| **Install packages**        | `npm install <pkg>`           | Alters dependencies      |
| **Git operations**          | `git push`, `merge`, `rebase` | Affects repo state       |
| **Create feature branch**   | `git checkout -b feat/name`   | Must follow naming convention |
| **Delete files**            | `rm`, `rmdir`                 | Irreversible             |
| **Edit environment/config** | `.env`, `vite.config.ts`      | Security impact          |
| **Call external APIs**      | Network writes                | May trigger side effects |
| **Modify payment logic**    | Changes to payment services   | Financial impact         |

### ğŸš« Prohibited (Never Allowed)

| Action                      | Command                       | Reason                   |
| --------------------------- | ----------------------------- | ------------------------ |
| **Push to main directly**   | `git push origin main`        | Breaks PR workflow       |
| **Merge without approval**  | `git merge feat/x` on main    | Requires code review     |
| **Force push to main**      | `git push -f origin main`     | Destructive              |

**Before L3 actions, agent must:**

1. Display the command and parameters
2. Explain the impact on payment flows
3. Wait for explicit approval

---

## 3. Development Commands

**âš¡ Prefer fast, file-scoped commands for low-cost feedback.**

### Global Commands

| Task         | Command           | Notes                |
| ------------ | ----------------- | -------------------- |
| Install deps | `npm install`     | First-time setup     |
| Serve dev    | `npm run dev`     | Opens on port 4200   |
| Build        | `npm run build`   | Production bundle    |
| Preview      | `npm run preview` | Test production build|
| Test all     | `npm test`        | Unit tests (Vitest)  |
| Test watch   | `npm test -- --watch` | Watch mode       |
| Lint all     | `npm run lint`    | ESLint check         |
| Lint fix     | `npm run lint -- --fix` | Auto-fix issues |

### Testing Commands

| Task                        | Command                      |
| --------------------------- | ---------------------------- |
| Unit tests                  | `npm test`                   |
| Unit tests with coverage    | `npm test -- --coverage`     |
| Install Playwright browsers | `npm run playwright:install` |
| E2E tests                   | `npm run test:e2e`           |
| E2E UI mode                 | `npm run test:e2e:ui`        |
| E2E headed mode             | `npm run test:e2e:headed`    |

### File-Scoped Examples

```bash
# Lint specific file
npx eslint src/app/components/payment-form/payment-form.component.ts --fix

# Format specific file
npx prettier --write src/app/services/payment.service.ts

# Type check specific file
npx tsc --noEmit src/app/models/payment.models.ts

# Test specific file
npm test -- src/app/services/payment.service.spec.ts
```

### Angular CLI Shortcuts

```bash
# Generate component
ng generate component components/checkout-summary

# Generate service
ng generate service services/fx-rate

# Generate interface
ng generate interface models/payment-link

# Generate guard
ng generate guard guards/payment-link
```

---

## 4. Code Standards

### Naming & Structure

| Type             | Format     | Example                      |
| ---------------- | ---------- | ---------------------------- |
| Component        | PascalCase | `PaymentFormComponent`       |
| Service          | PascalCase | `PaymentService`             |
| Interface / Type | PascalCase | `PaymentLink`, `Transaction` |
| File             | kebab-case | `payment-form.component.ts`  |
| Selector         | kebab-case | `<app-payment-form>`         |
| Signal           | camelCase  | `paymentStatus`              |

### Core Principles for Payment Systems

- **Never** use `any` type in payment-related code
- **Never** log sensitive data (card info, tokens)
- **Always** validate user input before API calls
- **Always** handle errors gracefully with user-friendly messages
- **Always** use signals for reactive state
- Use `Readonly` for configuration objects
- Split logic: services for business logic, components for UI
- No direct DOM access â†’ use `Renderer2`
- Prefer `ChangeDetectionStrategy.OnPush`

### Angular 20+ Modern Patterns

**ğŸ¯ This project uses Angular 20.x with modern patterns:**

- **Zoneless Change Detection**: Configured with `provideZonelessChangeDetection()`
- **Standalone Components**: All components must have `standalone: true`
- **Signals for State**: Use `signal()` and `computed()` for reactive state
- **Effects for Side Effects**: Use `effect()` for side effects based on signal changes

```typescript
// Example: Payment form with signals
@Component({
  selector: 'app-payment-form',
  standalone: true,
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class PaymentFormComponent {
  // State signals
  cardNumber = signal('');
  isProcessing = signal(false);
  
  // Computed validation
  isValidCard = computed(() => 
    this.luhnCheck(this.cardNumber())
  );
  
  constructor() {
    // Side effect when processing changes
    effect(() => {
      const processing = this.isProcessing();
      if (processing) {
        this.disableForm();
      }
    });
  }
}
```

### Payment Flow Architecture

**Key Payment Components:**
- `CheckoutComponent` â€” Main checkout page (hosts payment flow)
- `PaymentFormComponent` â€” Card input with validation
- `FeeBreakdownComponent` â€” Fee transparency display
- `PaymentSummaryComponent` â€” Order summary with FX conversion
- `PaymentStatusComponent` â€” Success/failure states

**Key Services:**
- `PaymentService` â€” Payment orchestration and API calls
- `FxRateService` â€” Real-time FX rate fetching
- `TokenizationService` â€” Mock card tokenization
- `ValidationService` â€” Card validation (Luhn, expiry, CVV)

**Models Location:** `src/app/models/`

### Card Validation Patterns

```typescript
/**
 * Card validation must happen client-side only.
 * Never send raw card data to backend.
 */

// âœ… CORRECT: Validate and tokenize
const isValid = validateCard(cardNumber, cvv, expiry);
if (isValid) {
  const token = generateMockToken(cardNumber);
  await paymentService.processPayment(token);
}

// âŒ WRONG: Send raw card data
await paymentService.processPayment({
  cardNumber,  // Never send this
  cvv,         // Never send this
  expiry       // Never send this
});
```

### Design Principles: YAGNI, KISS, and SOLID

| Principle | Check                                                                           |
| --------- | ------------------------------------------------------------------------------- |
| **YAGNI** | Is this feature used now? If not, remove it.                                    |
| **KISS**  | Can it be understood in <5 minutes? Simplify if not.                            |
| **SOLID** | Does each class/module have a single responsibility? Are dependencies injected? |

### Git Workflow & Branch Strategy

**ğŸš¨ CRITICAL: Never commit directly to `main` branch**

All changes must follow this workflow:

1. **Create feature branch** from `main`
2. **Make commits** to your feature branch
3. **Create Pull Request** for review
4. **Wait for approval** from team member
5. **Merge** only after approval

```bash
# âŒ NEVER DO THIS
git checkout main
git commit -m "feat: add payment feature"
git push origin main

# âœ… CORRECT WORKFLOW
git checkout main
git pull origin main
git checkout -b feat/payment-tokenization
git commit -m "feat(payment): add mock tokenization"
git push origin feat/payment-tokenization
# Then create PR via GitHub/GitLab UI
```

### Branch Naming Convention

| Type       | Pattern                    | Example                        |
| ---------- | -------------------------- | ------------------------------ |
| Feature    | `feat/short-description`   | `feat/card-validation`         |
| Bug Fix    | `fix/short-description`    | `fix/expiry-date-validation`   |
| Refactor   | `refactor/short-description` | `refactor/payment-service`   |
| Hotfix     | `hotfix/short-description` | `hotfix/critical-security`     |
| Docs       | `docs/short-description`   | `docs/update-agents-md`        |

### Git Commits

**Use [Conventional Commits](https://www.conventionalcommits.org/)**: `type(scope): description`

Common types for payment systems:
- `feat(payment)`: New payment feature
- `fix(validation)`: Fix card validation bug
- `refactor(checkout)`: Refactor checkout flow
- `test(payment)`: Add payment tests
- `docs(api)`: Update API documentation
- `security(tokenization)`: Security improvement

Breaking changes: add `!` â†’ `feat(payment)!: change token format`

### Pull Request Guidelines

**All PRs must include:**

- [ ] Clear title following conventional commits
- [ ] Description of changes and why
- [ ] Link to related issue/ticket (if applicable)
- [ ] Screenshots for UI changes
- [ ] Test coverage maintained/improved
- [ ] No breaking changes (or clearly documented)
- [ ] All CI checks passing

**PR Review Checklist:**

- [ ] Code follows style guide
- [ ] No security vulnerabilities introduced
- [ ] Payment logic has 100% test coverage
- [ ] No sensitive data logged or exposed
- [ ] Error handling is appropriate
- [ ] Documentation updated if needed

---

## 5. TSDoc Documentation Standards

**ğŸ“ All exported APIs must have TSDoc comments.**

> **Full spec:** [tsdoc.org](https://tsdoc.org/)

### Team Conventions

1. **Inline examples with "e.g.,"** - Every `@param`, `@returns`, and interface property MUST include example value
2. **@example blocks MANDATORY** - All payment-related functions must have examples
3. **Strict tag order** - Summary â†’ @param â†’ @returns â†’ @throws â†’ @example (non-negotiable)

### Payment System Documentation

````typescript
/**
 * Processes a payment using a tokenized card.
 *
 * @param paymentLinkId - Unique identifier for the payment link. E.g., 'pl_abc123xyz'
 * @param cardToken - Mock tokenized card data. E.g., 'tok_visa_4242'
 * @param idempotencyKey - Unique key to prevent duplicate charges. E.g., 'uuid-v4-string'
 * @returns Payment result with transaction details. E.g., { transactionId: 'txn_123', status: 'COMPLETED' }
 * @throws {PaymentError} When payment processing fails
 *
 * @example
 * ```typescript
 * const paymentService = inject(PaymentService);
 * const result = await paymentService.processPayment(
 *   'pl_abc123',
 *   'tok_visa_4242',
 *   crypto.randomUUID()
 * );
 * if (result.status === 'COMPLETED') {
 *   console.log('Payment successful:', result.transactionId);
 * }
 * ```
 */
async processPayment(
  paymentLinkId: string,
  cardToken: string,
  idempotencyKey: string
): Promise<PaymentResult> {
  // implementation
}
````

---

## 6. Quality Assurance Pipeline

ğŸ›¡ï¸ Every commit MUST pass the pipeline below:

### Step 1. Lint & Style

```bash
npm run lint -- --fix
npx prettier --write "src/**/*.{ts,html,scss}"
```

### Step 2. Unit Tests

```bash
npm test -- --coverage
```

âœ… **Minimum: 80% coverage**

**Critical: Payment logic must have 100% coverage**

### Step 3. Type & Build Verification

```bash
npx tsc --noEmit
npm run build
```

### Step 4. E2E Tests

**Important:** Install Playwright browsers first-time only:

```bash
npm run playwright:install
npm run test:e2e
```

### Quality Matrix

| Check      | Tool       | Target                 | Critical For |
| ---------- | ---------- | ---------------------- | ------------ |
| **Lint**   | ESLint     | 100% clean             | All files    |
| **Format** | Prettier   | 100% consistent        | All files    |
| **Test**   | Vitest     | â‰¥ 80% coverage         | All code     |
| **Payment**| Vitest     | 100% coverage          | Payment code |
| **E2E**    | Playwright | All flows passing      | Checkout     |
| **Type**   | TypeScript | 0 errors               | All files    |
| **Build**  | Vite       | Pass                   | Production   |
| **Docs**   | TSDoc      | All exports documented | Public APIs  |

---

## 7. Style & Reactivity

### CSS / Tailwind

- TailwindCSS for utility classes
- Component-scoped `.scss` for custom styles
- Avoid `::ng-deep` except when necessary
- Use **mobile-first** approach
- Payment forms must be responsive (mobile-optimized)

### Color Scheme for Payment States

```scss
// Success
.payment-success { @apply bg-green-50 text-green-700 border-green-300; }

// Error
.payment-error { @apply bg-red-50 text-red-700 border-red-300; }

// Processing
.payment-processing { @apply bg-blue-50 text-blue-700 border-blue-300; }

// Warning (e.g., FX volatility)
.payment-warning { @apply bg-yellow-50 text-yellow-700 border-yellow-300; }
```

### RxJS Usage

- Prefer **Signals** for local component state
- Use **Observables** for async operations (HTTP calls)
- Use `takeUntilDestroyed()` for subscription cleanup
- Combine flows with `switchMap`, `catchError`
- Always prefer `async` pipe in templates

```typescript
// âœ… CORRECT: Observable for HTTP + Signal for state
export class PaymentService {
  private http = inject(HttpClient);
  
  processPayment(data: PaymentData): Observable<PaymentResult> {
    return this.http.post<PaymentResult>('/api/payments', data).pipe(
      catchError(this.handlePaymentError)
    );
  }
}

export class PaymentFormComponent {
  private paymentService = inject(PaymentService);
  paymentStatus = signal<'idle' | 'processing' | 'success' | 'error'>('idle');
  
  submitPayment() {
    this.paymentStatus.set('processing');
    this.paymentService.processPayment(data)
      .pipe(takeUntilDestroyed(this.destroyRef))
      .subscribe({
        next: (result) => this.paymentStatus.set('success'),
        error: () => this.paymentStatus.set('error')
      });
  }
}
```

---

## 8. Testing Overview

**ğŸ§ª This project uses separate testing strategies for different concerns.**

### Testing Structure

| Test Type       | Framework  | Extension   | Location                    | Purpose                |
| --------------- | ---------- | ----------- | --------------------------- | ---------------------- |
| **Unit Tests**  | Vitest     | `.spec.ts`  | `src/app/**/*.spec.ts`      | Component/Service unit tests |
| **E2E Tests**   | Playwright | `.test.ts`  | `tests/**/*.test.ts`        | Full payment journey validation |

### Test Configuration

- **Unit Tests Setup**: `src/test-setup.ts` (JSDOM mocks)
- **E2E Tests Config**: `playwright.config.ts` (browser automation)
- **Coverage Thresholds**: 80% minimum, 100% for payment logic

### When to Use Each Test Type

**Use Unit Tests (Vitest) for:**
- Card validation logic (Luhn algorithm, expiry, CVV)
- Mock tokenization service
- Fee calculation logic
- FX conversion calculations
- Error handling and edge cases

**Use E2E Tests (Playwright) for:**
- Complete checkout flow (link â†’ form â†’ payment â†’ result)
- Payment success/failure scenarios
- FX rate volatility handling
- PSP failover scenarios
- Idempotency key handling

### Payment-Specific Test Patterns

```typescript
// Unit test: Card validation
describe('CardValidationService', () => {
  it('should validate valid Visa card', () => {
    const service = new CardValidationService();
    expect(service.validateCard('4242424242424242')).toBe(true);
  });
  
  it('should reject invalid card number', () => {
    const service = new CardValidationService();
    expect(service.validateCard('1234567890123456')).toBe(false);
  });
});

// E2E test: Complete payment flow
test('should complete payment successfully', async ({ page }) => {
  await page.goto('/checkout/pl_test123');
  await page.fill('[data-testid="card-number"]', '4242424242424242');
  await page.fill('[data-testid="cvv"]', '123');
  await page.fill('[data-testid="expiry"]', '12/25');
  await page.click('[data-testid="submit-payment"]');
  await expect(page.locator('[data-testid="payment-success"]')).toBeVisible();
});
```

---

## 9. Payment Flow Patterns

### ğŸ”„ Complete Payment Flow

```
1. User lands on checkout page with link_id
   â†“
2. Frontend fetches payment link details (GET /api/payment-links/{id})
   â†“
3. Display: USD amount, FX rate, MXN estimate, fee breakdown
   â†“
4. User enters card details
   â†“
5. Client-side validation (Luhn, expiry, CVV)
   â†“
6. Generate mock token (never send real card data)
   â†“
7. Call payment API (POST /api/payments)
   - paymentLinkId
   - cardToken
   - idempotencyKey (generated client-side)
   â†“
8. Handle response:
   - COMPLETED â†’ Show success page
   - FAILED â†’ Show error with retry option
   - PENDING â†’ Poll for status or wait for webhook
```

### State Management Pattern

```typescript
/**
 * Payment flow states
 */
type PaymentFlowState =
  | { status: 'loading' }
  | { status: 'ready'; data: PaymentLink }
  | { status: 'validating' }
  | { status: 'processing' }
  | { status: 'success'; transaction: Transaction }
  | { status: 'error'; error: PaymentError; canRetry: boolean };

// Component usage
export class CheckoutComponent {
  state = signal<PaymentFlowState>({ status: 'loading' });
  
  // Computed derived state
  canSubmit = computed(() => {
    const s = this.state();
    return s.status === 'ready' || (s.status === 'error' && s.canRetry);
  });
}
```

### Error Handling Pattern

```typescript
/**
 * Standardized payment error handling
 */
interface PaymentError {
  code: 'VALIDATION_ERROR' | 'PAYMENT_DECLINED' | 'NETWORK_ERROR' | 'TECHNICAL_ERROR';
  message: string;
  userMessage: string;  // Friendly message for display
  canRetry: boolean;
}

// Service implementation
handlePaymentError(error: unknown): Observable<never> {
  const paymentError: PaymentError = {
    code: this.classifyError(error),
    message: error instanceof Error ? error.message : 'Unknown error',
    userMessage: this.getUserFriendlyMessage(error),
    canRetry: this.isRetryable(error)
  };
  
  return throwError(() => paymentError);
}
```

### Idempotency Pattern

```typescript
/**
 * Generate idempotency key for payment requests
 * Prevents duplicate charges on retry
 */
export class PaymentFormComponent {
  private idempotencyKey = signal<string>(crypto.randomUUID());
  
  submitPayment() {
    // Use same key for retries within this session
    const key = this.idempotencyKey();
    
    this.paymentService.processPayment({
      paymentLinkId: this.linkId,
      cardToken: this.tokenizedCard(),
      idempotencyKey: key
    }).subscribe({
      next: (result) => {
        // Success - generate new key for next payment
        this.idempotencyKey.set(crypto.randomUUID());
      },
      error: (error) => {
        // Keep same key for retry
      }
    });
  }
}
```

### FX Volatility Handling

```typescript
/**
 * Display FX volatility warning to users
 */
export class FeeBreakdownComponent {
  private fxService = inject(FxRateService);
  
  fxRate = signal<number | null>(null);
  showVolatilityWarning = signal(true);
  
  ngOnInit() {
    // Fetch rate on preview
    this.fxService.getCurrentRate('USD', 'MXN')
      .subscribe(rate => this.fxRate.set(rate));
  }
  
  // Template shows:
  // "âš ï¸ Exchange rate may vary slightly at payment time"
}
```

---

## 10. Operational Checklist

| âœ… Checkpoint        | Requirement                                    |
| -------------------- | ---------------------------------------------- |
| **Typing strict**    | `noImplicitAny`, `strictNullChecks`            |
| **Coverage**         | â‰¥ 80% overall, 100% for payment logic          |
| **Style**            | Prettier + ESLint clean                        |
| **TSDoc**            | All exported entities documented with examples |
| **Change Detection** | `OnPush` for all components                    |
| **Signals**          | Use for reactive state (zoneless)              |
| **Async**            | Use Observables + `async` pipe                 |
| **Card Security**    | Never log/store/transmit real card data        |
| **Tokenization**     | Always tokenize before sending to backend      |
| **Idempotency**      | All payment requests include idempotency key   |
| **Error Handling**   | User-friendly messages for all error states    |
| **Git Workflow**     | Always work on feature branch, never push to main |
| **Pull Requests**    | All changes via PR with approval required      |
| **Permissions**      | Follow L2/L3 rules before destructive actions  |

---

## 11. When Stuck ğŸ¤”

If uncertain about a change:

1. Do **not** make speculative edits, especially in payment logic.
2. Propose a **short execution plan** summarizing what you intend to modify.
3. For payment-related changes, explain the security implications.
4. Ask the user for confirmation or create a **draft PR** with notes.
5. Document unresolved questions in a comment block before continuing.
6. **Never push directly to main** - always work on a feature branch.

**Special considerations for payment code:**
- Always explain impact on payment flow
- Highlight any changes to validation logic
- Note any changes to error handling
- Clarify any changes to tokenization process

**Git workflow when stuck:**
```bash
# If you started work but are uncertain
git stash                           # Save current work
git checkout main                   # Return to main
git pull origin main                # Update main
git checkout -b draft/exploration   # Create draft branch
git stash pop                       # Restore work
# Create draft PR for discussion
```

---

## 12. Output Format (Do / Understand / Undo) ğŸª„

When delivering changes to the user:

1. **Do:** Provide exact commands or code to apply.
2. **Understand:** Explain the intent and impact on payment flow.
3. **Undo:** Include precise revert steps.

**Example 1: Running Tests**

```
DO:
npm test -- src/app/services/payment.service.spec.ts
```

**UNDERSTAND:**
This runs unit tests for the payment service to verify tokenization logic works correctly.

**UNDO:**
No undo needed - test execution doesn't modify code.

---

**Example 2: Creating a Feature Branch**

```
DO:
git checkout main
git pull origin main
git checkout -b feat/card-validation-improvement
```

**UNDERSTAND:**
Creates a new feature branch from updated main to work on card validation improvements.
This follows the PR workflow and ensures we never commit directly to main.

**UNDO:**
```bash
git checkout main
git branch -D feat/card-validation-improvement
```

---

**Example 3: Committing Changes**

```
DO:
git add src/app/services/validation.service.ts
git commit -m "feat(validation): improve Luhn algorithm performance"
git push origin feat/card-validation-improvement
```

**UNDERSTAND:**
Commits validation improvements to feature branch and pushes for PR creation.
Follows conventional commits format for clear change tracking.

**UNDO:**
```bash
git reset --soft HEAD~1  # Undo commit, keep changes
# or
git reset --hard HEAD~1  # Undo commit and discard changes
```

---

## ğŸ“š Project-Specific References

### Payment Link Structure

```typescript
interface PaymentLink {
  id: string;               // e.g., 'pl_abc123'
  merchantId: string;       // e.g., 'merchant_xyz'
  amountUsd: number;        // e.g., 100.00
  status: 'ACTIVE' | 'COMPLETED' | 'EXPIRED';
  expiresAt: Date;
  metadata?: Record<string, unknown>;
}
```

### Transaction States

```typescript
type TransactionStatus = 
  | 'PENDING'      // Initial state, payment in progress
  | 'COMPLETED'    // Payment successful
  | 'FAILED';      // Payment declined or error
```

### PSP Integration

```typescript
interface PSPAttempt {
  psp: 'STRIPE' | 'ADYEN';
  status: 'SUCCESS' | 'DECLINE' | 'ERROR';
  attemptedAt: Date;
  latencyMs: number;
}
```

---

## ğŸ” Security Reminders

**CRITICAL: Never compromise on these security principles:**

1. âŒ Never log card numbers, CVV, or expiry dates
2. âŒ Never store card data in localStorage or sessionStorage
3. âŒ Never send raw card data to backend
4. âœ… Always tokenize card data client-side (mock for this project)
5. âœ… Always validate card data before tokenization
6. âœ… Always use HTTPS in production
7. âœ… Always include idempotency keys in payment requests
8. âœ… Always show clear error messages without exposing system internals

---

## ğŸ¯ Success Criteria

A successful implementation of Kira Payment Links Frontend includes:

- âœ… Checkout page loads payment link details correctly
- âœ… FX rate displays accurately with real-time updates
- âœ… Fee breakdown is clear and transparent
- âœ… Card validation works for all major card types
- âœ… Mock tokenization prevents real card data transmission
- âœ… Payment submission handles success/failure/retry flows
- âœ… Error messages are user-friendly and actionable
- âœ… All payment logic has 100% test coverage
- âœ… E2E tests cover complete payment journey
- âœ… No sensitive data logged or exposed

---

> ğŸ§  **Note:**
> AGENTS.md is the single source of truth for automated and human contributors.  
> All AI agents must respect this document's hierarchy and constraints.  
> When uncertain, especially with payment logic, pause execution, summarize the plan, and request user confirmation.  
> **Security and accuracy are paramount in payment systems.**
> 
> **Git Workflow Reminder:**  
> âš ï¸ **NEVER commit directly to `main` branch**  
> âœ… Always work on feature branches  
> âœ… All changes must go through Pull Request review  
> âœ… Wait for approval before merging

--- END OF FILE: agents.md ---

--- START OF FILE: angular.json ---
{
  "$schema": "./node_modules/@angular/cli/lib/config/schema.json",
  "version": 1,
  "newProjectRoot": "",
  "projects": {
    "app": {
      "projectType": "application",
      "root": "",
      "sourceRoot": "src",
      "prefix": "app",
      "architect": {
        "build": {
          "builder": "@angular/build:application",
          "options": {
            "outputPath": {
              "base": "dist"
            },
            "index": "src/index.html",
            "browser": "src/main.ts",
            "polyfills": [],
            "tsConfig": "tsconfig.json"
          },
          "configurations": {
            "production": {
              "outputHashing": "all",
              "optimization": true
            },
            "development": {
              "optimization": false,
              "extractLicenses": false,
              "sourceMap": true
            }
          },
          "defaultConfiguration": "production"
        },
        "serve": {
          "builder": "@angular/build:dev-server",
          "options": {
            "port": 9002
          },
          "configurations": {
            "production": {
              "buildTarget": "app:build:production"
            },
            "development": {
              "buildTarget": "app:build:development"
            }
          },
          "defaultConfiguration": "development"
        },
        "lint": {
          "builder": "@angular-eslint/builder:lint",
          "options": {
            "lintFilePatterns": [
              ".//**/*.ts",
              ".//**/*.html"
            ]
          }
        }
      }
    }
  },
  "cli": {
    "schematicCollections": [
      "angular-eslint"
    ]
  }
}

--- END OF FILE: angular.json ---

--- START OF FILE: eslint.config.js ---
// @ts-check
import eslint from "@eslint/js";
import tseslint from "typescript-eslint";
import angular from "angular-eslint";

export default tseslint.config(
  {
    files: ["**/*.ts"],
    extends: [
      eslint.configs.recommended,
      ...tseslint.configs.recommended,
      ...tseslint.configs.stylistic,
      ...angular.configs.tsRecommended,
    ],
    processor: angular.processInlineTemplates,
    rules: {
      "@angular-eslint/directive-selector": [
        "error",
        {
          type: "attribute",
          prefix: "app",
          style: "camelCase",
        },
      ],
      "@angular-eslint/component-selector": [
        "error",
        {
          type: "element",
          prefix: "app",
          style: "kebab-case",
        },
      ],
    },
  },
  {
    files: ["**/*.html"],
    extends: [
      ...angular.configs.templateRecommended,
      ...angular.configs.templateAccessibility,
    ],
    rules: {},
  }
);

--- END OF FILE: eslint.config.js ---

--- START OF FILE: metadata.json ---
{
  "name": "Payment Link Checkout",
  "description": "A frontend application that serves as the checkout interface for a payment link API. It allows users to view payment details, including fee breakdowns, and securely enter their card information to complete a payment.",
  "requestFramePermissions": []
}
--- END OF FILE: metadata.json ---

--- START OF FILE: package.json ---
{
  "name": "payment-link-checkout",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "ng serve --port 9002 --host 0.0.0.0",
    "build": "ng build",
    "preview": "ng serve --configuration=production",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage",
    "lint": "ng lint"
  },
  "engines": {
    "node": ">=20.19.0"
  },
  "dependencies": {
    "@angular/build": "^20.3.0",
    "@angular/cli": "^20.3.0",
    "@angular/common": "^20.3.0",
    "@angular/compiler": "^20.3.0",
    "@angular/compiler-cli": "^20.3.0",
    "@angular/core": "^20.3.0",
    "@angular/forms": "^20.3.12",
    "@angular/platform-browser": "^20.3.0",
    "@angular/router": "^20.3.12",
    "rxjs": "^7.8.2",
    "tailwindcss": "latest"
  },
  "devDependencies": {
    "@analogjs/vite-plugin-angular": "^2.0.5",
    "@angular/platform-browser-dynamic": "^20.3.12",
    "@types/node": "^22.14.0",
    "@vitest/coverage-v8": "^3.2.4",
    "@vitest/ui": "^3.2.4",
    "angular-eslint": "20.6.0",
    "eslint": "^9.39.0",
    "jsdom": "^27.2.0",
    "typescript": "~5.8.2",
    "typescript-eslint": "8.46.3",
    "vite": "^6.2.0",
    "vitest": "^3.2.4",
    "zone.js": "^0.15.1"
  }
}

--- END OF FILE: package.json ---

--- START OF FILE: src/app.component.html ---

<main class="min-h-screen flex items-center justify-center p-4">
  <router-outlet></router-outlet>
</main>

--- END OF FILE: src/app.component.html ---

--- START OF FILE: src/app.component.ts ---

import { ChangeDetectionStrategy, Component } from '@angular/core';
import { RouterOutlet } from '@angular/router';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [RouterOutlet]
})
export class AppComponent {}

--- END OF FILE: src/app.component.ts ---

--- START OF FILE: src/app.routes.ts ---
import { Routes } from '@angular/router';
import { CheckoutComponent } from './components/checkout/checkout.component';

export const APP_ROUTES: Routes = [
  {
    path: 'links/:id',
    component: CheckoutComponent
  },
  {
    path: 'links',
    component: CheckoutComponent
  },
  {
    path: '',
    redirectTo: '/links',
    pathMatch: 'full'
  },
  {
    path: '**',
    redirectTo: '/links'
  }
];
--- END OF FILE: src/app.routes.ts ---

--- START OF FILE: src/components/checkout/checkout.component.html ---
<div class="w-full max-w-md mx-auto">
  @switch (status()) {
    @case ('INITIALIZING') {
      <div class="flex flex-col items-center justify-center p-10 bg-white rounded-xl shadow-lg">
        <svg class="animate-spin h-10 w-10 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-slate-600 font-medium">Initializing...</p>
      </div>
    }
    @case ('AWAITING_INPUT') {
      <div class="p-8 bg-white rounded-xl shadow-lg text-center">
        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Find Your Payment Link</h2>
        <p class="mt-2 text-slate-600 max-w-sm mx-auto">Please enter the ID of your payment link to proceed with your payment.</p>
    
        <form (submit)="search()" class="mt-8">
          <div class="flex gap-2">
            <input type="text" [formControl]="searchControl" placeholder="Enter Payment Link ID" class="flex-grow block w-full px-4 py-3 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
            <button type="submit" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-6 rounded-lg transition-colors">
              Find
            </button>
          </div>
           @if(searchControl.touched && searchControl.invalid) {
            <p class="mt-2 text-xs text-red-600 text-left">Please enter a valid link ID.</p>
          }
        </form>
      </div>
    }
    @case ('LOADING_LINK') {
      <div class="flex flex-col items-center justify-center p-10 bg-white rounded-xl shadow-lg">
        <svg class="animate-spin h-10 w-10 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-slate-600 font-medium">Loading payment details...</p>
      </div>
    }
    @case ('LINK_NOT_FOUND') {
      <div class="p-8 bg-white rounded-xl shadow-lg text-center">
        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Payment Link Not Found</h2>
        <p class="mt-2 text-slate-600">The payment link you are trying to access is invalid or has expired.</p>
        
        <form (submit)="search()" class="mt-8">
          <div class="flex gap-2">
            <input type="text" [formControl]="searchControl" placeholder="Enter Payment Link ID" class="flex-grow block w-full px-4 py-3 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
            <button type="submit" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-6 rounded-lg transition-colors">
              Search
            </button>
          </div>
           @if(searchControl.touched && searchControl.invalid) {
            <p class="mt-2 text-xs text-red-600 text-left">Please enter a valid link ID.</p>
          }
        </form>
      </div>
    }
    @case ('ERROR_RETRYABLE') {
      <div class="p-8 bg-white rounded-xl shadow-lg text-center">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
          <svg class="h-10 w-10 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
        </div>
        <h2 class="mt-4 text-2xl font-bold text-slate-800">Payment Error</h2>
        <p class="mt-2 text-slate-600">{{ errorMessage() }}</p>
        <button (click)="retry()" class="mt-6 w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-4 rounded-lg transition-colors">
          Try Again
        </button>
      </div>
    }
    @case ('COMPLETED') {
      <app-payment-status [status]="status()" [result]="paymentResult()"></app-payment-status>
    }
    @case ('FAILED') {
      <app-payment-status [status]="status()" [result]="paymentResult()"></app-payment-status>
    }
    @case ('READY_TO_PAY') {
      @if (paymentLink(); as link) {
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="p-6">
            <h1 class="text-2xl font-bold text-slate-800">{{ link.description }}</h1>
            <p class="text-sm text-slate-500">Merchant ID: {{ link.merchantId }}</p>

            <div class="mt-6 text-center">
              <p class="text-slate-600">Total Amount Due</p>
              <p class="text-5xl font-extrabold text-slate-900 tracking-tight">{{ totalAmount() | currency:'USD':'symbol':'1.2-2' }}</p>
            </div>
            
            <app-fee-breakdown [feePreview]="link.feePreview" [baseAmount]="link.amountUsd"></app-fee-breakdown>
          </div>
          
          <div class="bg-slate-50 p-6">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">Pay with card</h2>
            <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()" novalidate>
              <div class="space-y-4">
                <div>
                  <label for="cardHolder" class="block text-sm font-medium text-slate-700">Cardholder Name</label>
                  <input type="text" id="cardHolder" formControlName="cardHolder" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                </div>
                <div>
                  <label for="cardNumber" class="block text-sm font-medium text-slate-700">Card Number</label>
                  <input type="tel" id="cardNumber" formControlName="cardNumber" (input)="formatCardNumber($event)" placeholder="0000 0000 0000 0000" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                  @if(paymentForm.controls.cardNumber.touched && paymentForm.controls.cardNumber.errors) {
                    <p class="mt-1 text-xs text-red-600">Please enter a valid card number.</p>
                  }
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="expiryDate" class="block text-sm font-medium text-slate-700">Expiry Date</label>
                    <input type="tel" id="expiryDate" formControlName="expiryDate" (input)="formatExpiryDate($event)" placeholder="MM / YY" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                     @if(paymentForm.controls.expiryDate.touched && paymentForm.controls.expiryDate.errors) {
                      <p class="mt-1 text-xs text-red-600">Enter a valid MM/YY date.</p>
                    }
                  </div>
                  <div>
                    <label for="cvc" class="block text-sm font-medium text-slate-700">CVC</label>                    <input type="tel" id="cvc" formControlName="cvc" placeholder="123" maxlength="4" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                     @if(paymentForm.controls.cvc.touched && paymentForm.controls.cvc.errors) {
                      <p class="mt-1 text-xs text-red-600">Enter a valid CVC.</p>
                    }
                  </div>
                </div>
              </div>

              <button type="submit" [disabled]="status() === 'PROCESSING_PAYMENT'" class="mt-6 w-full flex justify-center items-center bg-slate-800 hover:bg-slate-900 disabled:bg-slate-400 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                @if (status() === 'PROCESSING_PAYMENT') {
                  <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Processing...
                } @else {
                  <span>Pay {{ totalAmount() | currency:'USD':'symbol':'1.2-2' }}</span>
                }
              </button>
            </form>
          </div>
        </div>
      }
    }
  }
</div>
--- END OF FILE: src/components/checkout/checkout.component.html ---

--- START OF FILE: src/components/checkout/checkout.component.ts ---

import { ChangeDetectionStrategy, Component, computed, inject, OnInit, signal } from '@angular/core';
import { ActivatedRoute, Router, RouterOutlet } from '@angular/router';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { CommonModule, CurrencyPipe } from '@angular/common';
import { catchError, finalize, of } from 'rxjs';
import { HttpErrorResponse } from '@angular/common/http';

import { ApiService } from '../../services/api.service';
import { MockPspSdkService } from '../../services/mock-psp-sdk.service';
import { ValidationService } from '../../services/validation.service';
import { CheckoutStatus, PaymentLinkWithPreviewResponse, ProcessPaymentResponse } from '../../models/payment.model';
import { FeeBreakdownComponent } from '../fee-breakdown/fee-breakdown.component';
import { PaymentStatusComponent } from '../payment-status/payment-status.component';

@Component({
  selector: 'app-checkout',
  templateUrl: './checkout.component.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [
    CommonModule,
    RouterOutlet,
    ReactiveFormsModule,
    CurrencyPipe,
    FeeBreakdownComponent,
    PaymentStatusComponent
  ]
})
export class CheckoutComponent implements OnInit {
  private route = inject(ActivatedRoute);
  private router = inject(Router);
  private fb = inject(FormBuilder);
  private apiService = inject(ApiService);
  private mockSdkService = inject(MockPspSdkService);
  private validationService = inject(ValidationService);

  status = signal<CheckoutStatus>('INITIALIZING');
  paymentLink = signal<PaymentLinkWithPreviewResponse | null>(null);
  paymentResult = signal<ProcessPaymentResponse | null>(null);
  errorMessage = signal<string | null>(null);

  totalAmount = computed(() => {
    const link = this.paymentLink();
    if (!link) return 0;
    const total = Number(link.amountUsd) + Number(link.feePreview.totalFeesUsd);
    return Math.round(total * 100) / 100;
  });

  paymentForm = this.fb.group({
    cardNumber: ['', [Validators.required, Validators.minLength(16), Validators.maxLength(19), this.validationService.luhnValidator()]],
    expiryDate: ['', [Validators.required, Validators.pattern(/^(0[1-9]|1[0-2])\s?\/\s?([2-9][0-9])$/)]],
    cvc: ['', [Validators.required, Validators.minLength(3), Validators.maxLength(4), Validators.pattern(/^\d+$/)]],
    cardHolder: ['Juan PÃ©rez', [Validators.required, Validators.minLength(3)]]
  });
  
  searchControl = this.fb.control('', [Validators.required, Validators.minLength(5)]);

  ngOnInit(): void {
    this.route.params.subscribe(params => {
      const id = params['id'];
      if (id) {
        this.loadLink(id);
      } else {
        this.status.set('AWAITING_INPUT');
      }
    });
  }

  loadLink(id: string): void {
    this.status.set('LOADING_LINK');
    this.apiService.getPaymentLink(id).pipe(
      catchError(() => {
        this.status.set('LINK_NOT_FOUND');
        this.searchControl.setValue(id);
        return of(null);
      })
    ).subscribe(data => {
      if (data) {
        this.paymentLink.set(data);
        this.status.set('READY_TO_PAY');
      }
    });
  }

  search(): void {
    if (this.searchControl.invalid) {
      this.searchControl.markAsTouched();
      return;
    }
    const linkId = this.searchControl.value?.trim();
    if (linkId) {
      this.router.navigate(['/links', linkId]);
    }
  }

  async onSubmit(): Promise<void> {
    if (this.paymentForm.invalid) {
      this.paymentForm.markAllAsTouched();
      return;
    }

    this.status.set('PROCESSING_PAYMENT');
    this.paymentForm.disable();
    this.errorMessage.set(null);

    try {
      const cardToken = await this.mockSdkService.createToken('STRIPE');
      const idempotencyKey = crypto.randomUUID();
      const id = this.paymentLink()?.id;
      if(!id) {
          throw new Error('Payment link ID is missing');
      }
      
      const { cardHolder } = this.paymentForm.getRawValue();

      this.apiService.processPayment(id, {
        cardToken,
        idempotencyKey,
        pspProvider: 'STRIPE',
        metadata: {
          cardHolder
        }
      }).pipe(
          catchError((error: HttpErrorResponse) => {
              const apiError = error.error;
              if (apiError && typeof apiError.message === 'string') {
                  this.errorMessage.set(apiError.message);
              } else {
                  this.errorMessage.set(`We couldn't process your payment at this time. Please try again.`);
              }
              this.status.set('ERROR_RETRYABLE');
              return of(null);
          }),
          finalize(() => this.paymentForm.enable())
      ).subscribe(response => {
        if(response) {
            this.paymentResult.set(response);
            if(response.status === 'COMPLETED') {
                this.status.set('COMPLETED');
            } else {
                this.status.set('FAILED');
            }
        }
      });

    } catch {
      this.errorMessage.set('An unexpected error occurred while preparing the payment. Please try again.');
      this.status.set('ERROR_RETRYABLE');
      this.paymentForm.enable();
    }
  }
  
  formatCardNumber(event: Event) {
    const input = event.target as HTMLInputElement;
    let value = input.value.replace(/\D/g, '').substring(0, 16);
    value = value.replace(/(\d{4})/g, '$1 ').trim();
    this.paymentForm.controls.cardNumber.setValue(value, { emitEvent: false });
  }

  formatExpiryDate(event: Event) {
    const input = event.target as HTMLInputElement;
    let value = input.value.replace(/\D/g, '').substring(0, 4);
    if (value.length > 2) {
      value = `${value.substring(0, 2)} / ${value.substring(2)}`;
    }
    this.paymentForm.controls.expiryDate.setValue(value, { emitEvent: false });
  }

  retry() {
    this.status.set('READY_TO_PAY');
    this.paymentResult.set(null);
    this.errorMessage.set(null);
  }
}

--- END OF FILE: src/components/checkout/checkout.component.ts ---

--- START OF FILE: src/components/fee-breakdown/fee-breakdown.component.html ---

@if (feePreview(); as preview) {
  <div class="mt-6 border border-slate-200 rounded-lg">
    <button (click)="toggle()" class="w-full flex justify-between items-center p-3 text-left">
      <span class="font-medium text-slate-700">Payment Breakdown</span>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" 
           class="w-5 h-5 text-slate-500 transition-transform"
           [class.rotate-180]="isOpen()">
        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
      </svg>
    </button>
    
    @if (isOpen()) {
      <div class="p-4 border-t border-slate-200 bg-slate-50 text-sm">
        <ul class="space-y-2 text-slate-600">
          <li class="flex justify-between">
            <span>Item Price</span>
            <span class="font-medium text-slate-800">{{ baseAmount() | currency:'USD':'symbol':'1.2-2' }}</span>
          </li>
          <li class="flex justify-between">
            <span>Fixed Fee</span>
            <span>{{ preview.breakdown.fixedFeeUsd | currency:'USD':'symbol':'1.2-2' }}</span>
          </li>
          <li class="flex justify-between">
            <span>Variable Fee</span>
            <span>{{ preview.breakdown.variableFeeUsd | currency:'USD':'symbol':'1.2-2' }}</span>
          </li>
           <li class="flex justify-between">
            <span>FX Markup</span>
            <span>{{ preview.breakdown.fxMarkupUsd | currency:'USD':'symbol':'1.2-2' }}</span>
          </li>
          @if (preview.breakdown.firstTxDiscountUsd > 0) {
            <li class="flex justify-between text-green-600">
              <span>First Transaction Discount</span>
              <span>- {{ preview.breakdown.firstTxDiscountUsd | currency:'USD':'symbol':'1.2-2' }}</span>
            </li>
          }
           <li class="flex justify-between font-semibold pt-2 border-t border-slate-200 text-slate-800">
            <span>Total Fees</span>
            <span>{{ preview.totalFeesUsd | currency:'USD':'symbol':'1.2-2' }}</span>
          </li>
        </ul>

        <div class="mt-4 pt-4 border-t border-dashed border-slate-300">
           <p class="text-xs text-slate-500 text-center">
              Exchange Rate: 1 USD â‰ˆ {{ preview.fxRate | number:'1.2-2' }} MXN. <br> Recipient will receive ~{{ preview.recipientAmountMxn | currency:'MXN':'symbol':'1.2-2' }}.
           </p>
        </div>
      </div>
    }
  </div>
}

--- END OF FILE: src/components/fee-breakdown/fee-breakdown.component.html ---

--- START OF FILE: src/components/fee-breakdown/fee-breakdown.component.ts ---

import { ChangeDetectionStrategy, Component, input, signal } from '@angular/core';
import { CommonModule, CurrencyPipe } from '@angular/common';
import { FeePreview } from '../../models/payment.model';

@Component({
  selector: 'app-fee-breakdown',
  templateUrl: './fee-breakdown.component.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [CommonModule, CurrencyPipe]
})
export class FeeBreakdownComponent {
  feePreview = input.required<FeePreview>();
  baseAmount = input.required<number>();

  isOpen = signal(false);

  toggle() {
    this.isOpen.update(open => !open);
  }
}

--- END OF FILE: src/components/fee-breakdown/fee-breakdown.component.ts ---

--- START OF FILE: src/components/payment-status/payment-status.component.html ---
<div class="p-8 bg-white rounded-xl shadow-lg text-center">
  @if (status() === 'COMPLETED') {
    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100">
      <svg class="h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
      </svg>
    </div>
    <h2 class="mt-4 text-2xl font-bold text-slate-800">Payment Successful!</h2>
    <p class="mt-2 text-slate-600">Your payment has been processed successfully.</p>
  } @else {
    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
      <svg class="h-10 w-10 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </div>
    <h2 class="mt-4 text-2xl font-bold text-slate-800">Payment Declined</h2>
    <p class="mt-2 text-slate-600">Unfortunately, your payment could not be processed. Please check your card details or try a different card.</p>
  }

  @if (result(); as res) {
    <div class="mt-6 text-left text-sm bg-slate-50 p-4 rounded-lg border border-slate-200">
      <dl class="grid grid-cols-3 gap-x-4 gap-y-2">
        <dt class="text-slate-500 col-span-1">Status</dt>
        <dd class="text-slate-700 font-medium col-span-2">{{ res.status }}</dd>

        <dt class="text-slate-500 col-span-1">Transaction ID</dt>
        <dd class="text-slate-700 font-medium col-span-2 break-all">{{ res.transactionId }}</dd>
        
        <dt class="text-slate-500 col-span-1">Total Paid</dt>
        <dd class="text-slate-700 font-medium col-span-2">{{ res.amountUsd | currency:'USD' }}</dd>
        
        <dt class="text-slate-500 col-span-1">Total Fees</dt>
        <dd class="text-slate-700 font-medium col-span-2">{{ res.totalFeesUsd | currency:'USD' }}</dd>
        
        <dt class="text-slate-500 col-span-1">Recipient Receives</dt>
        <dd class="text-slate-700 font-bold col-span-2">{{ res.recipientAmountMxn | currency:'MXN' }}</dd>

        <dt class="text-slate-500 col-span-1">FX Rate</dt>
        <dd class="text-slate-700 font-medium col-span-2">1 USD â‰ˆ {{ res.fxRateApplied | number:'1.4-4' }} MXN</dd>

        <dt class="text-slate-500 col-span-1">PSP</dt>
        <dd class="text-slate-700 font-medium col-span-2">{{ res.pspProvider }}</dd>
      </dl>
    </div>
  }
</div>

--- END OF FILE: src/components/payment-status/payment-status.component.html ---

--- START OF FILE: src/components/payment-status/payment-status.component.ts ---

import { ChangeDetectionStrategy, Component, input } from '@angular/core';
import { CommonModule, CurrencyPipe } from '@angular/common';
import { ProcessPaymentResponse } from '../../models/payment.model';

@Component({
  selector: 'app-payment-status',
  templateUrl: './payment-status.component.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [CommonModule, CurrencyPipe]
})
export class PaymentStatusComponent {
  status = input.required<'COMPLETED' | 'FAILED'>();
  result = input.required<ProcessPaymentResponse | null>();
}

--- END OF FILE: src/components/payment-status/payment-status.component.ts ---

--- START OF FILE: src/index.html ---
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kira Payment Links</title>
  <base href="/kira-frontend/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
  <app-root></app-root>
</body>
</html>
--- END OF FILE: src/index.html ---

--- START OF FILE: src/main.ts ---

import '@angular/compiler';
import { bootstrapApplication } from '@angular/platform-browser';
import { provideRouter, withHashLocation } from '@angular/router';
import { provideHttpClient } from '@angular/common/http';
import { provideZonelessChangeDetection } from '@angular/core';

import { AppComponent } from './app.component';
import { APP_ROUTES } from './app.routes';

bootstrapApplication(AppComponent, {
  providers: [
    provideZonelessChangeDetection(),
    provideRouter(APP_ROUTES, withHashLocation()),
    provideHttpClient(),
  ],
}).catch(err => console.error(err));

--- END OF FILE: src/main.ts ---

--- START OF FILE: src/models/payment.model.spec.ts ---
import { describe, it, expect } from 'vitest';
import type {
  FeePreview,
  PaymentLinkResponse,
  PaymentLinkWithPreviewResponse,
  ProcessPaymentRequest,
  ProcessPaymentResponse,
  CheckoutStatus,
} from './payment.model';

describe('Payment Models', () => {
  describe('FeePreview', () => {
    it('should create a valid FeePreview object', () => {
      const feePreview: FeePreview = {
        fxRate: 20.5,
        totalFeesUsd: 5.50,
        recipientAmountMxn: 2050,
        breakdown: {
          fixedFeeUsd: 2.00,
          variableFeeUsd: 2.50,
          fxMarkupUsd: 1.00,
          firstTxDiscountUsd: 0,
        },
      };

      expect(feePreview.fxRate).toBe(20.5);
      expect(feePreview.totalFeesUsd).toBe(5.50);
      expect(feePreview.recipientAmountMxn).toBe(2050);
      expect(feePreview.breakdown.fixedFeeUsd).toBe(2.00);
    });
  });

  describe('PaymentLinkResponse', () => {
    it('should create a valid PaymentLinkResponse object', () => {
      const paymentLink: PaymentLinkResponse = {
        id: 'link123',
        merchantId: 'merchant123',
        status: 'ACTIVE',
        amountUsd: 100,
        description: 'Test payment',
        expiresAt: null,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z',
        checkoutUrl: 'https://example.com/checkout/link123',
      };

      expect(paymentLink.id).toBe('link123');
      expect(paymentLink.status).toBe('ACTIVE');
    });

    it('should accept all valid status values', () => {
      const statuses: PaymentLinkResponse['status'][] = [
        'DRAFT',
        'ACTIVE',
        'EXPIRED',
        'COMPLETED',
        'CANCELLED',
      ];

      statuses.forEach((status) => {
        const link: PaymentLinkResponse = {
          id: 'test',
          merchantId: 'merchant',
          status,
          amountUsd: 100,
          description: 'Test',
          expiresAt: null,
          createdAt: '2024-01-01T00:00:00Z',
          updatedAt: '2024-01-01T00:00:00Z',
          checkoutUrl: 'https://example.com',
        };
        expect(link.status).toBe(status);
      });
    });
  });

  describe('PaymentLinkWithPreviewResponse', () => {
    it('should extend PaymentLinkResponse with feePreview', () => {
      const paymentLinkWithPreview: PaymentLinkWithPreviewResponse = {
        id: 'link123',
        merchantId: 'merchant123',
        status: 'ACTIVE',
        amountUsd: 100,
        description: 'Test payment',
        expiresAt: null,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z',
        checkoutUrl: 'https://example.com/checkout/link123',
        feePreview: {
          fxRate: 20.5,
          totalFeesUsd: 5.50,
          recipientAmountMxn: 2050,
          breakdown: {
            fixedFeeUsd: 2.00,
            variableFeeUsd: 2.50,
            fxMarkupUsd: 1.00,
            firstTxDiscountUsd: 0,
          },
        },
      };

      expect(paymentLinkWithPreview.feePreview).toBeDefined();
      expect(paymentLinkWithPreview.feePreview.fxRate).toBe(20.5);
    });
  });

  describe('ProcessPaymentRequest', () => {
    it('should create a valid ProcessPaymentRequest with STRIPE', () => {
      const request: ProcessPaymentRequest = {
        cardToken: 'tok_stripe_123',
        pspProvider: 'STRIPE',
        idempotencyKey: 'key123',
        metadata: { userId: 'user123' },
      };

      expect(request.pspProvider).toBe('STRIPE');
      expect(request.cardToken).toBe('tok_stripe_123');
    });

    it('should create a valid ProcessPaymentRequest with ADYEN', () => {
      const request: ProcessPaymentRequest = {
        cardToken: 'tok_adyen_123',
        pspProvider: 'ADYEN',
        idempotencyKey: 'key456',
      };

      expect(request.pspProvider).toBe('ADYEN');
      expect(request.metadata).toBeUndefined();
    });
  });

  describe('ProcessPaymentResponse', () => {
    it('should create a valid completed payment response', () => {
      const response: ProcessPaymentResponse = {
        transactionId: 'txn123',
        status: 'COMPLETED',
        paymentLinkId: 'link123',
        pspProvider: 'STRIPE',
        amountUsd: 100,
        recipientAmountMxn: 2050,
        fxRateApplied: 20.5,
        totalFeesUsd: 5.50,
      };

      expect(response.status).toBe('COMPLETED');
      expect(response.transactionId).toBe('txn123');
    });

    it('should create a valid failed payment response', () => {
      const response: ProcessPaymentResponse = {
        transactionId: 'txn456',
        status: 'FAILED',
        paymentLinkId: 'link456',
        pspProvider: 'ADYEN',
        amountUsd: 100,
        recipientAmountMxn: 0,
        fxRateApplied: 20.5,
        totalFeesUsd: 0,
      };

      expect(response.status).toBe('FAILED');
    });
  });

  describe('CheckoutStatus', () => {
    it('should accept all valid checkout status values', () => {
      const statuses: CheckoutStatus[] = [
        'INITIALIZING',
        'AWAITING_INPUT',
        'LOADING_LINK',
        'LINK_NOT_FOUND',
        'READY_TO_PAY',
        'PROCESSING_PAYMENT',
        'COMPLETED',
        'FAILED',
        'ERROR_RETRYABLE',
      ];

      statuses.forEach((status) => {
        const currentStatus: CheckoutStatus = status;
        expect(currentStatus).toBe(status);
      });
    });
  });
});

--- END OF FILE: src/models/payment.model.spec.ts ---

--- START OF FILE: src/models/payment.model.ts ---
export interface FeePreview {
  fxRate: number;
  totalFeesUsd: number;
  recipientAmountMxn: number;
  breakdown: {
    fixedFeeUsd: number;
    variableFeeUsd: number;
    fxMarkupUsd: number;
    firstTxDiscountUsd: number;
  };
}

export interface PaymentLinkResponse {
  id: string;
  merchantId: string;
  status: 'DRAFT' | 'ACTIVE' | 'EXPIRED' | 'COMPLETED' | 'CANCELLED';
  amountUsd: number;
  description: string;
  expiresAt: string | null;
  createdAt: string;
  updatedAt: string;
  checkoutUrl: string;
}

export interface PaymentLinkWithPreviewResponse extends PaymentLinkResponse {
  feePreview: FeePreview;
}

export interface ProcessPaymentRequest {
  cardToken: string;
  pspProvider: 'STRIPE' | 'ADYEN';
  idempotencyKey: string;
  metadata?: Record<string, unknown>;
}

export interface ProcessPaymentResponse {
  transactionId: string;
  status: 'COMPLETED' | 'FAILED';
  paymentLinkId: string;
  pspProvider: 'STRIPE' | 'ADYEN';
  amountUsd: number;
  recipientAmountMxn: number;
  fxRateApplied: number;
  totalFeesUsd: number;
}

export type CheckoutStatus =
  | 'INITIALIZING'
  | 'AWAITING_INPUT'
  | 'LOADING_LINK'
  | 'LINK_NOT_FOUND'
  | 'READY_TO_PAY'
  | 'PROCESSING_PAYMENT'
  | 'COMPLETED'
  | 'FAILED'
  | 'ERROR_RETRYABLE';
--- END OF FILE: src/models/payment.model.ts ---

--- START OF FILE: src/services/api.service.spec.ts ---
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { TestBed } from '@angular/core/testing';
import { provideHttpClient } from '@angular/common/http';
import { HttpTestingController, provideHttpClientTesting } from '@angular/common/http/testing';
import { ApiService } from './api.service';
import { PaymentLinkWithPreviewResponse, ProcessPaymentRequest, ProcessPaymentResponse } from '../models/payment.model';

describe('ApiService', () => {
  let service: ApiService;
  let httpTesting: HttpTestingController;
  const baseUrl = 'https://kira-payment-api.onrender.com';

  beforeEach(() => {
    TestBed.configureTestingModule({
      providers: [
        ApiService,
        provideHttpClient(),
        provideHttpClientTesting(),
      ],
    });
    service = TestBed.inject(ApiService);
    httpTesting = TestBed.inject(HttpTestingController);
  });

  afterEach(() => {
    httpTesting.verify();
  });

  it('should be created', () => {
    expect(service).toBeDefined();
  });

  describe('getPaymentLink', () => {
    it('should retrieve payment link by id', () => {
      const mockResponse: PaymentLinkWithPreviewResponse = {
        id: 'link123',
        merchantId: 'merchant123',
        status: 'ACTIVE',
        amountUsd: 100,
        description: 'Test payment',
        expiresAt: null,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z',
        checkoutUrl: 'https://example.com/checkout/link123',
        feePreview: {
          fxRate: 20.5,
          totalFeesUsd: 5.50,
          recipientAmountMxn: 2050,
          breakdown: {
            fixedFeeUsd: 2.00,
            variableFeeUsd: 2.50,
            fxMarkupUsd: 1.00,
            firstTxDiscountUsd: 0,
          },
        },
      };

      service.getPaymentLink('link123').subscribe((response) => {
        expect(response).toEqual(mockResponse);
      });

      const req = httpTesting.expectOne(`${baseUrl}/payment-links/link123`);
      expect(req.request.method).toBe('GET');
      req.flush(mockResponse);
    });

    it('should handle different payment link ids', () => {
      const testIds = ['abc123', 'xyz789', 'test-id-001'];

      testIds.forEach((id) => {
        service.getPaymentLink(id).subscribe();
        const req = httpTesting.expectOne(`${baseUrl}/payment-links/${id}`);
        expect(req.request.method).toBe('GET');
        req.flush({});
      });
    });
  });

  describe('processPayment', () => {
    it('should process payment with correct request', () => {
      const paymentRequest: ProcessPaymentRequest = {
        cardToken: 'tok_test_123',
        pspProvider: 'STRIPE',
        idempotencyKey: 'key123',
        metadata: { userId: 'user123' },
      };

      const mockResponse: ProcessPaymentResponse = {
        transactionId: 'txn123',
        status: 'COMPLETED',
        paymentLinkId: 'link123',
        pspProvider: 'STRIPE',
        amountUsd: 100,
        recipientAmountMxn: 2050,
        fxRateApplied: 20.5,
        totalFeesUsd: 5.50,
      };

      service.processPayment('link123', paymentRequest).subscribe((response) => {
        expect(response).toEqual(mockResponse);
      });

      const req = httpTesting.expectOne(`${baseUrl}/payment-links/link123/payments`);
      expect(req.request.method).toBe('POST');
      expect(req.request.body).toEqual(paymentRequest);
      req.flush(mockResponse);
    });

    it('should handle ADYEN provider', () => {
      const paymentRequest: ProcessPaymentRequest = {
        cardToken: 'tok_adyen_123',
        pspProvider: 'ADYEN',
        idempotencyKey: 'key456',
      };

      service.processPayment('link456', paymentRequest).subscribe();

      const req = httpTesting.expectOne(`${baseUrl}/payment-links/link456/payments`);
      expect(req.request.body.pspProvider).toBe('ADYEN');
      req.flush({});
    });

    it('should handle failed payment status', () => {
      const paymentRequest: ProcessPaymentRequest = {
        cardToken: 'tok_fail_123',
        pspProvider: 'STRIPE',
        idempotencyKey: 'key789',
      };

      const mockResponse: ProcessPaymentResponse = {
        transactionId: 'txn456',
        status: 'FAILED',
        paymentLinkId: 'link789',
        pspProvider: 'STRIPE',
        amountUsd: 100,
        recipientAmountMxn: 0,
        fxRateApplied: 20.5,
        totalFeesUsd: 0,
      };

      service.processPayment('link789', paymentRequest).subscribe((response) => {
        expect(response.status).toBe('FAILED');
      });

      const req = httpTesting.expectOne(`${baseUrl}/payment-links/link789/payments`);
      req.flush(mockResponse);
    });
  });
});

--- END OF FILE: src/services/api.service.spec.ts ---

--- START OF FILE: src/services/api.service.ts ---
import { inject, Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { PaymentLinkWithPreviewResponse, ProcessPaymentRequest, ProcessPaymentResponse } from '../models/payment.model';

@Injectable({
  providedIn: 'root'
})
export class ApiService {
  private http = inject(HttpClient);
  private baseUrl = 'https://kira-payment-api.onrender.com'; 

  getPaymentLink(id: string): Observable<PaymentLinkWithPreviewResponse> {
    return this.http.get<PaymentLinkWithPreviewResponse>(`${this.baseUrl}/payment-links/${id}`);
  }

  processPayment(id: string, request: ProcessPaymentRequest): Observable<ProcessPaymentResponse> {
    return this.http.post<ProcessPaymentResponse>(`${this.baseUrl}/payment-links/${id}/payments`, request);
  }
}
--- END OF FILE: src/services/api.service.ts ---

--- START OF FILE: src/services/mock-psp-sdk.service.spec.ts ---
import { describe, it, expect, beforeEach } from 'vitest';
import { TestBed } from '@angular/core/testing';
import { MockPspSdkService } from './mock-psp-sdk.service';

describe('MockPspSdkService', () => {
  let service: MockPspSdkService;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    service = TestBed.inject(MockPspSdkService);
  });

  it('should be created', () => {
    expect(service).toBeDefined();
  });

  describe('createToken', () => {
    it('should return a token for STRIPE', async () => {
      const token = await service.createToken('STRIPE');
      expect(token).toBeDefined();
      expect(typeof token).toBe('string');
      expect(token).toMatch(/^tok_mock_stripe_/);
    });

    it('should return a token for ADYEN', async () => {
      const token = await service.createToken('ADYEN');
      expect(token).toBeDefined();
      expect(typeof token).toBe('string');
      expect(token).toMatch(/^tok_mock_adyen_/);
    });

    it('should return different tokens on multiple calls', async () => {
      const token1 = await service.createToken('STRIPE');
      const token2 = await service.createToken('STRIPE');
      expect(token1).not.toBe(token2);
    });

    it('should simulate network latency', async () => {
      const startTime = Date.now();
      await service.createToken('STRIPE');
      const endTime = Date.now();
      const duration = endTime - startTime;

      // Should take at least 500ms (minimum latency)
      expect(duration).toBeGreaterThanOrEqual(500);
      // Should not take more than 1500ms (maximum latency + some buffer)
      expect(duration).toBeLessThan(1500);
    });

    it('should include UUID in token', async () => {
      const token = await service.createToken('STRIPE');
      // UUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
      const uuidPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
      expect(token).toMatch(uuidPattern);
    });
  });
});

--- END OF FILE: src/services/mock-psp-sdk.service.spec.ts ---

--- START OF FILE: src/services/mock-psp-sdk.service.ts ---

import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class MockPspSdkService {

  createToken(psp: 'STRIPE' | 'ADYEN'): Promise<string> {
    return new Promise(resolve => {
      // Simulate network latency for the tokenization request
      const latency = 500 + Math.random() * 500; // 500ms to 1000ms
      
      setTimeout(() => {
        const token = `tok_mock_${psp.toLowerCase()}_${crypto.randomUUID()}`;
        resolve(token);
      }, latency);
    });
  }
}

--- END OF FILE: src/services/mock-psp-sdk.service.ts ---

--- START OF FILE: src/services/validation.service.spec.ts ---
import { describe, it, expect, beforeEach } from 'vitest';
import { TestBed } from '@angular/core/testing';
import { FormControl } from '@angular/forms';
import { ValidationService } from './validation.service';

describe('ValidationService', () => {
  let service: ValidationService;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    service = TestBed.inject(ValidationService);
  });

  describe('luhnValidator', () => {
    it('should be created', () => {
      expect(service).toBeDefined();
    });

    it('should return null for empty value', () => {
      const validator = service.luhnValidator();
      const control = new FormControl('');
      expect(validator(control)).toBeNull();
    });

    it('should return null for null value', () => {
      const validator = service.luhnValidator();
      const control = new FormControl(null);
      expect(validator(control)).toBeNull();
    });

    it('should return error for non-numeric value', () => {
      const validator = service.luhnValidator();
      const control = new FormControl('abcd');
      expect(validator(control)).toEqual({ luhn: true });
    });

    it('should return error for invalid card number', () => {
      const validator = service.luhnValidator();
      const control = new FormControl('1234567890123456');
      expect(validator(control)).toEqual({ luhn: true });
    });

    it('should return null for valid card number (Visa)', () => {
      const validator = service.luhnValidator();
      // Valid test Visa card number
      const control = new FormControl('4532015112830366');
      expect(validator(control)).toBeNull();
    });

    it('should return null for valid card number (Mastercard)', () => {
      const validator = service.luhnValidator();
      // Valid test Mastercard number
      const control = new FormControl('5425233430109903');
      expect(validator(control)).toBeNull();
    });

    it('should handle card numbers with spaces', () => {
      const validator = service.luhnValidator();
      const control = new FormControl('4532 0151 1283 0366');
      expect(validator(control)).toBeNull();
    });

    it('should return error for card number with invalid checksum', () => {
      const validator = service.luhnValidator();
      const control = new FormControl('4532015112830367');
      expect(validator(control)).toEqual({ luhn: true });
    });

    it('should validate simple valid Luhn number', () => {
      const validator = service.luhnValidator();
      const control = new FormControl('79927398713');
      expect(validator(control)).toBeNull();
    });

    it('should reject simple invalid Luhn number', () => {
      const validator = service.luhnValidator();
      const control = new FormControl('79927398714');
      expect(validator(control)).toEqual({ luhn: true });
    });
  });
});

--- END OF FILE: src/services/validation.service.spec.ts ---

--- START OF FILE: src/services/validation.service.ts ---

import { Injectable } from '@angular/core';
import { AbstractControl, ValidationErrors, ValidatorFn } from '@angular/forms';

@Injectable({
  providedIn: 'root'
})
export class ValidationService {

  luhnValidator(): ValidatorFn {
    return (control: AbstractControl): ValidationErrors | null => {
      if (!control.value) {
        return null;
      }
      
      const value = control.value.toString().replace(/\s+/g, '');

      if (!/^\d+$/.test(value)) {
        return { luhn: true }; // Not a number
      }

      let sum = 0;
      let shouldDouble = false;
      for (let i = value.length - 1; i >= 0; i--) {
        let digit = parseInt(value.charAt(i), 10);

        if (shouldDouble) {
          digit *= 2;
          if (digit > 9) {
            digit -= 9;
          }
        }

        sum += digit;
        shouldDouble = !shouldDouble;
      }

      return (sum % 10) === 0 ? null : { luhn: true };
    };
  }
}

--- END OF FILE: src/services/validation.service.ts ---

--- START OF FILE: src/test-setup.ts ---
import 'zone.js';
import 'zone.js/testing';
import { getTestBed } from '@angular/core/testing';
import {
  BrowserDynamicTestingModule,
  platformBrowserDynamicTesting,
} from '@angular/platform-browser-dynamic/testing';

// Initialize the Angular testing environment
getTestBed().initTestEnvironment(
  BrowserDynamicTestingModule,
  platformBrowserDynamicTesting(),
);

--- END OF FILE: src/test-setup.ts ---

--- START OF FILE: tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": [
    "src/**/*"
  ],
  "angularCompilerOptions": {
    "disableTypeScriptVersionCheck": true
  }
}
--- END OF FILE: tsconfig.json ---

--- START OF FILE: tsconfig.spec.json ---
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./out-tsc/spec",
    "types": ["vitest/globals", "node"]
  },
  "include": ["src/**/*.spec.ts", "src/**/*.test.ts", "src/test-setup.ts"]
}

--- END OF FILE: tsconfig.spec.json ---

--- START OF FILE: vitest.config.ts ---
import { defineConfig } from 'vitest/config';
import angular from '@analogjs/vite-plugin-angular';

export default defineConfig({
  plugins: [
    angular({
      tsconfig: 'tsconfig.spec.json',
    }),
  ],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['src/test-setup.ts'],
    include: ['**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test-setup.ts',
        '**/*.spec.ts',
        '**/*.test.ts',
        '**/main.ts',
      ],
    },
  },
  resolve: {
    alias: {
      '@': '/src',
    },
  },
});

--- END OF FILE: vitest.config.ts ---

